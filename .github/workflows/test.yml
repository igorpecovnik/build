name: CI
on:
  push:
    branches: master
  schedule:
    - cron:  '0 */3 * * *'
jobs:
    
    
    docker-bionic:
      name: Create Docker image on Bionic
      runs-on: ubuntu-18.04
      steps:
        - uses: actions/checkout@v1
        - run: |
            sed -i "s/-it --rm/-i --rm/" config/templates/config-docker.conf
            touch .ignore_changes
            ./compile.sh docker KERNEL_ONLY="yes" BOARD="bananapi" BRANCH="current" KERNEL_CONFIGURE="no" \
            USE_TORRENT="yes" REPOSITORY_INSTALL="kernel" 'prepare_host'



    docker-focal:
      name: Create Docker image on Focal
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v1
        - run: |
            sed -i "s/-it --rm/-i --rm/" config/templates/config-docker.conf
            touch .ignore_changes
            ./compile.sh docker KERNEL_ONLY="yes" BOARD="bananapi" BRANCH="current" KERNEL_CONFIGURE="no" \
            USE_TORRENT="yes" REPOSITORY_INSTALL="kernel" 'prepare_host'



    docker-hirsute:
      name: Create Docker image on Hirsute
      runs-on: [self-hosted, Linux, x64]
      steps:
        - name: Checkout Armbian build script
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/build
            path: build
            ref: nightly
            clean: false
        - run: |
            cd build
            sed -i "s/-it --rm/-i --rm/" config/templates/config-docker.conf
            [[ ! -f .ignore_changes ]] && sudo touch .ignore_changes
            ./compile.sh dockerpurge KERNEL_ONLY="yes" BOARD="bananapi" BRANCH="current" KERNEL_CONFIGURE="no" USE_TORRENT="yes" REPOSITORY_INSTALL="kernel" 'prepare_host'
 
    kernels:
      name: Build changed kernels
      runs-on: [self-hosted, Linux, x64]
      steps:
        - name: Checkout Armbian build script
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/build
            path: build
            ref: nightly
            clean: false
        - name: Checkout Armbian support scripts
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/scripts
            token: ${{ secrets.PAT }}
            path: scripts
            clean: false
        - run: |
            echo "BLTPATH=\"$(pwd)/build/\"" | tee scripts/cacherebuild.conf scripts/betarepository.conf >/dev/null
            [[ ! -f build/.ignore_changes ]] && sudo touch build/.ignore_changes
            sudo cp scripts/configs/* userpatches/
            sudo rm -r build/output/debs/* 
            sudo rm -r build/output/debs-beta/* 
            sudo rm -f userpatches/targets.conf
            sudo sed -i "s/-it --rm/-i --rm/" config/templates/config-docker.conf
            cd build
            ./compile.sh docker all-new-stable-kernels


    edge-stable:
      name: Update edge kernels in stable repo
      runs-on: [self-hosted, Linux, x64]
      steps:
        - name: Checkout Armbian build script
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/build
            path: build
            ref: nightly
            clean: false
        - name: Checkout Armbian support scripts
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/scripts
            token: ${{ secrets.PAT }}
            path: scripts
            clean: false
        - run: |
            echo "BLTPATH=\"$(pwd)/build/\"" | tee scripts/cacherebuild.conf scripts/betarepository.conf >/dev/null
            [[ ! -f build/.ignore_changes ]] && sudo touch build/.ignore_changes
            sudo cp scripts/configs/* userpatches/
            sudo rm -r build/output/debs/*             
            sudo rm -r build/output/debs-beta/*             
            sudo rm -f userpatches/targets.conf
            sudo sed -i "s/-it --rm/-i --rm/" config/templates/config-docker.conf
            cd build
            cat config/targets.conf | grep edge | grep cli | grep hirsute | sudo tee userpatches/targets.conf 1>/dev/null 
            ./compile.sh all-new-stable-kernels
            # upgrade only kernel packages
            find output/debs -mindepth 1 -maxdepth 1 -type d -print0  | xargs -0 rm -R 2> /dev/null
            rm -f output/debs/armbian-* 2> /dev/null
            rm -f output/debs/linux-libc-* 2> /dev/null

    repository:
      name: Update repository
      needs: [kernels, edge-stable] 
      runs-on: [self-hosted, Linux, x64]
      steps:
        - name: Install SSH key for repository
          uses: shimataro/ssh-key-action@v2
          with:
            key: ${{ secrets.KEY_FOR_REPOSITORY }}
            name: id_repository # optional
            known_hosts: ${{ secrets.KNOWN_HOSTS_REPOSITORY }}
            if_key_exists: replace
        - name: Update repository
          run: ssh -i ~/.ssh/id_repository ${{ secrets.USER_REPOSITORY }}@${{ secrets.SSH_HOST }}
    finish:
      name: Cleaning
      needs: [docker-bionic, docker-focal, docker-hirsute, kernels, edge-stable]
      runs-on: [self-hosted, Linux, x64]
      steps:
        - name: Run script
          shell: bash {0}
          run: |
            echo "xxxx"
