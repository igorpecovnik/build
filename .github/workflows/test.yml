name: CI
on:
  push:
    branches: master
  schedule:
    - cron:  '0 */3 * * *'
jobs:
  
    
    docker-bionic:
      name: Build docker image on Bionic
      runs-on: ubuntu-18.04
      steps:
        - uses: actions/checkout@v1
        - run: |
            sed -i "s/-it --rm/-i --rm/" config/templates/config-docker.conf
            touch .ignore_changes
            ./compile.sh docker KERNEL_ONLY="yes" BOARD="bananapi" BRANCH="current" KERNEL_CONFIGURE="no" \
            USE_TORRENT="yes" REPOSITORY_INSTALL="kernel" 'prepare_host'


    docker-focal:
      name: Build Docker image on Focal
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v1
        - run: |
            sed -i "s/-it --rm/-i --rm/" config/templates/config-docker.conf
            touch .ignore_changes
            ./compile.sh docker KERNEL_ONLY="yes" BOARD="bananapi" BRANCH="current" KERNEL_CONFIGURE="no" \
            USE_TORRENT="yes" REPOSITORY_INSTALL="kernel" 'prepare_host'


    kernels:
      name: Build all changed kernels in beta repository
      runs-on: [self-hosted, Linux, x64]

      steps:

        - name: Checkout Armbian build script
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/build
            path: build
            ref: nightly
            clean: false

        - name: Checkout Armbian support scripts
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/scripts
            token: ${{ secrets.PAT }}
            path: scripts
            clean: false

        - run: |
            cd build
            #sudo sed -i "s/-it --rm/-i --rm/" userpatches/config-docker.conf
            #./compile.sh docker KERNEL_ONLY="yes" BOARD="bananapi" BRANCH="current" KERNEL_CONFIGURE="no" USE_TORRENT="no" REPOSITORY_INSTALL="kernel" 'prepare_host'
            #mkdir -p cache/hash-beta
            #sudo rsync -ar ../scripts/hash-beta/* cache/hash-beta/
            [[ ! -f .ignore_changes ]] && sudo touch .ignore_changes
            sudo cp ../scripts/configs/* userpatches/
            sudo rm -f userpatches/targets.conf
            #sudo sed -i "s/-it --rm/-i --rm/" userpatches/config-docker.conf
            ./compile.sh all-new-beta-kernels
            #sudo rsync -ar cache/hash-beta/* ../scripts/hash-beta/

        - name: Install SSH key for repository
          uses: shimataro/ssh-key-action@v2
          with:
            key: ${{ secrets.KEY_FOR_REPOSITORY }}
            name: id_repository # optional
            known_hosts: ${{ secrets.KNOWN_HOSTS_REPOSITORY }}
            if_key_exists: replace

        - run: |
            sudo apt-get -y -qq install lftp
            lftp -u upload, -e "set net:timeout 4;set net:max-retries 6;mirror --Remove-source-files -R --parallel=8 --no-perms build/output/ ;bye" sftp://users.armbian.com

    repository:
      name: Update repository
      needs: kernels 
      runs-on: [self-hosted, Linux, x64]
      steps:
        - name: Install SSH key for repository
          uses: shimataro/ssh-key-action@v2
          with:
            key: ${{ secrets.KEY_FOR_REPOSITORY }}
            name: id_repository # optional
            known_hosts: ${{ secrets.KNOWN_HOSTS_REPOSITORY }}
            if_key_exists: replace
        - name: Update repository
          run: ssh -i ~/.ssh/id_repository ${{ secrets.USER_REPOSITORY }}@${{ secrets.SSH_HOST }}


    finish:
      name: Cleaning
      needs: [docker-bionic, docker-focal, kernels]
      runs-on: [self-hosted, Linux, x64]
      steps:
        - name: Run script
          shell: bash {0}
          run: |
            echo "xxxx"
