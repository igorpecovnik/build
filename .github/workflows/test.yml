name: Armbian CI Pro
on:
  push:
    branches: master
  schedule:
    - cron:  '0 */3 * * *'
jobs:
    prepare:
      runs-on: [self-hosted, Linux, x64]
      steps:
        - name: Checkout Armbian build script
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/build
            path: build
            ref: nightly
            clean: false
        - name: Checkout Armbian support scripts
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/scripts
            token: ${{ secrets.PAT }}
            path: scripts
            clean: false
    parallel:
      runs-on: [self-hosted, Linux, x64]
      strategy:
        matrix:
          run: ['Rootfs cache rebuild', 'run2']
      steps:
        - run: |
            echo "BLTPATH=\"$(pwd)/build/\"" | tee scripts/cacherebuild.conf scripts/betarepository.conf >/dev/null
            cd build
            if [[ ! -f .ignore_changes ]]; then
               ./compile.sh BOARD=cubietruck BRANCH=current KERNEL_ONLY="yes" RELEASE=focal KERNEL_CONFIGURE="no" 'prepare_host'
               touch .ignore_changes
            fi
            cp ../scripts/configs/* userpatches/
            cd ..
            cd scripts
            run-one ./cacherebuild.sh
        - run: echo Run ${{ matrix.run }}
    finish:
      needs: prepare
      runs-on: [self-hosted, Linux, x64]
      steps:
        - name: Run script
          shell: bash {0}
          run: |
            echo "xxxx"
