name: Update Armbian

on:

  workflow_dispatch:

  push:
    branches: master

  schedule:
    - cron:  '0 */3 * * *'

jobs:

    docker:
      name: Build Docker image
      runs-on: [self-hosted, Linux, x64]
      steps:
        - run: |
            sudo chown -R $USER:$USER .
        - uses: actions/checkout@v1
        - run: |
            sed -i "s/-it --rm/-i --rm/" config/templates/config-docker.conf
            touch .ignore_changes
            ./compile.sh dockerpurge KERNEL_ONLY="yes" BOARD="bananapi" BRANCH="current" KERNEL_CONFIGURE="no" \
            USE_TORRENT="yes" REPOSITORY_INSTALL="kernel" 'prepare_host'


    kernels:
      name: Build all changed kernels in beta repository
      runs-on: [self-hosted, Linux, x64]
      steps:
        - run: |
            sudo chown -R $USER:$USER .
        - name: Checkout Armbian build script
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/build
            path: build
            ref: nightly
            clean: false
        - name: Checkout Armbian support scripts
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/scripts
            token: ${{ secrets.PAT }}
            path: scripts
            clean: false
        - name: Build all changed kernels
          run: |
            echo "BLTPATH=\"$(pwd)/build/\"" | tee scripts/cacherebuild.conf scripts/betarepository.conf >/dev/null
            cd build
            [[ ! -f .ignore_changes ]] && sudo touch .ignore_changes
            ./compile.sh KERNEL_ONLY="yes" BOARD="bananapi" BRANCH="current" KERNEL_CONFIGURE="no" \
            USE_TORRENT="yes" REPOSITORY_INSTALL="kernel" 'prepare_host'
            mkdir -p cache/hash-beta
            sudo rsync -ar ../scripts/hash-beta/* cache/hash-beta/
            sudo cp ../scripts/configs/* userpatches/
            sudo rm -f userpatches/targets.conf
            ./compile.sh all-new-beta-kernels
            sudo rsync -ar cache/hash-beta/* ../scripts/hash-beta/
        - name: Install SSH key for repository
          uses: shimataro/ssh-key-action@v2
          with:
            key: ${{ secrets.KEY_FOR_TORRENT }}
            #name: id_rsa # optional
            known_hosts: ${{ secrets.KNOWN_HOSTS_TORRENT }}
            if_key_exists: replace
        - name: Deploy to server
          run: |            
            sudo apt-get -y -qq install lftp
            sudo lftp -u upload, -e "set net:timeout 4;set net:max-retries 6;mirror --Remove-source-files -R --parallel=8 --no-perms $(pwd)/build/output/debs-beta/ . ;bye" sftp://users.armbian.com


    edge-stable:
      name: Build edge changed kernels in stable repo repository
      runs-on: [self-hosted, Linux, x64]
      steps:
        - run: |
            sudo chown -R $USER:$USER .
        - name: Checkout Armbian build script
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/build
            path: build
            ref: nightly
            clean: false
        - name: Checkout Armbian support scripts
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/scripts
            token: ${{ secrets.PAT }}
            path: scripts
            clean: false
        - name: Build all edge changed kernels for stable repository
          run: |
            echo "BLTPATH=\"$(pwd)/build/\"" | tee scripts/cacherebuild.conf scripts/betarepository.conf >/dev/null
            sudo sed -i "s/-it --rm/-i --rm/" build/config/templates/config-docker.conf
            cd build
            [[ ! -f .ignore_changes ]] && sudo touch .ignore_changes
            ./compile.sh KERNEL_ONLY="yes" BOARD="bananapi" BRANCH="current" KERNEL_CONFIGURE="no" \
            USE_TORRENT="yes" REPOSITORY_INSTALL="kernel" 'prepare_host'
            mkdir -p cache/hash/
            sudo rsync -ar ../scripts/hash/* cache/hash/
            sudo cp ../scripts/configs/* userpatches/
            cat config/targets.conf | grep edge | grep cli | grep hirsute | sudo tee userpatches/targets.conf 1>/dev/null 
            sudo sed -i "s/-it --rm/-i --rm/" userpatches/config-docker.conf
            ./compile.sh all-new-stable-kernels
            # upgrade only kernel packages
            #find output/debs -mindepth 1 -maxdepth 1 -type d -print0  | xargs -0 rm -fR 2> /dev/null
            rm -f output/debs/armbian-* 2> /dev/null
            rm -f output/debs/linux-libc-* 2> /dev/null
            sudo rsync -ar cache/hash/* ../scripts/hash/
        - name: Install SSH key for storage
          uses: shimataro/ssh-key-action@v2
          with:
            key: ${{ secrets.KEY_FOR_TORRENT }}
            #name: id_rsa # optional
            known_hosts: ${{ secrets.KNOWN_HOSTS_TORRENT }}
            if_key_exists: replace
        - run: |
            sudo apt-get -y -qq install lftp
            sudo lftp -u upload, -e "set net:timeout 4;set net:max-retries 6;mirror --Remove-source-files -R --parallel=8 --no-perms $(pwd)/build/output/debs/ . ;bye" sftp://users.armbian.com

    repository:
      name: Update repository
      needs: [kernels, edge-stable] 
      runs-on: [self-hosted, Linux, x64]
      steps:
        - name: Install SSH key for repository
          uses: shimataro/ssh-key-action@v2
          with:
            key: ${{ secrets.KEY_FOR_REPOSITORY }}
            name: id_repository # optional
            known_hosts: ${{ secrets.KNOWN_HOSTS_REPOSITORY }}
            if_key_exists: replace
        - name: Update repository
          run: ssh -i ~/.ssh/id_repository ${{ secrets.USER_REPOSITORY }}@${{ secrets.SSH_HOST }}


    finish:
      name: Cleaning
      needs: [docker, kernels, edge-stable]
      runs-on: [self-hosted, Linux, x64]
      steps:
        - name: Run script
          shell: bash {0}
          run: |
            echo "xxxx"
